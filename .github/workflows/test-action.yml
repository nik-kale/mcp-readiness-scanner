name: Test MCP Readiness Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allows manual trigger from Actions tab

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install package from local source
        run: |
          pip install -e .

      - name: Create test tool files
        run: |
          mkdir -p test-tools

          # Create a "bad" tool (missing timeout, no error schema, etc.)
          cat > test-tools/bad_tool.json << 'EOF'
          {
            "name": "do_everything",
            "description": "Executes any operation",
            "inputSchema": {
              "type": "object",
              "properties": {
                "action": { "type": "string" }
              }
            }
          }
          EOF

          # Create a "good" tool (has all the right configs)
          cat > test-tools/good_tool.json << 'EOF'
          {
            "name": "fetch_user",
            "version": "1.0.0",
            "description": "Fetches user profile by ID. Returns 404 if not found. Connections auto-closed on timeout. Resources cleaned up via context manager.",
            "timeout": 30000,
            "maxRetries": 3,
            "rateLimit": {
              "maxRequests": 100,
              "windowMs": 60000
            },
            "inputSchema": {
              "type": "object",
              "properties": {
                "userId": {
                  "type": "string",
                  "description": "Unique user identifier"
                }
              },
              "required": ["userId"]
            },
            "outputSchema": {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "name": { "type": "string" }
              }
            },
            "errorSchema": {
              "type": "object",
              "properties": {
                "code": { "type": "string" },
                "message": { "type": "string" }
              }
            },
            "observability": {
              "logging": { "level": "info" },
              "metrics": { "enabled": true }
            }
          }
          EOF

      - name: Test scan-tool command (bad tool)
        run: |
          echo "=== Scanning bad_tool.json ==="
          mcp-readiness scan-tool --tool test-tools/bad_tool.json --format markdown || true
          echo ""
          echo "Exit code: $?"

      - name: Test scan-tool command (good tool)
        run: |
          echo "=== Scanning good_tool.json ==="
          mcp-readiness scan-tool --tool test-tools/good_tool.json --format markdown || true
          echo ""
          echo "Exit code: $?"

      - name: Test JSON output format
        run: |
          echo "=== Testing JSON output ==="
          mcp-readiness scan-tool --tool test-tools/bad_tool.json --format json || true

      - name: Test the GitHub Action locally
        uses: ./
        with:
          tool: test-tools/good_tool.json
          format: markdown
          fail-on-critical: 'true'
          fail-on-high: 'false'

      - name: Verify action completed
        run: |
          echo "âœ… All tests passed!"
